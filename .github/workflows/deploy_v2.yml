name: Deploy KAI Core V2

on:
  push:
    branches:
      - develop
      - main
    paths:
      - 'src/**'
      - 'main.py'
      - 'Dockerfile'
      - 'requirements.txt'
      - '.github/workflows/deploy_v2.yml'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  REPO_NAME: kai-corev2-api

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. Autenticación con Google Cloud
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 2. Setup de gcloud SDK
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'

      # 3. Configurar Docker para Artifact Registry / GCR
      - name: 'Configure Docker'
        run: |
          gcloud auth configure-docker

      # 4. Construir y Subir Imagen (Usando commit SHA como tag)
      - name: 'Build and Push Container'
        run: |
          gcloud builds submit --tag gcr.io/$PROJECT_ID/$REPO_NAME:${{ github.sha }}

      # ==================================================================
      # DESPLIEGUE A DESARROLLO (Rama: develop)
      # ==================================================================
      - name: 'Deploy to Cloud Run (DEV)'
        if: github.ref == 'refs/heads/develop'
        uses: 'google-github-actions/deploy-cloudrun@v1'
        with:
          service: 'kai-api-corev2-dev'
          image: 'gcr.io/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}:${{ github.sha }}'
          region: '${{ env.REGION }}'
          flags: '--allow-unauthenticated --memory=4Gi --cpu=4'
          env_vars: |
            GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
            LOCATION=${{ env.REGION }}
            GEMINI_MODEL_ID=gemini-2.5-flash
            
            # Base de Datos (Cloud SQL)
            DB_USER=${{ secrets.DB_USER }}
            DB_PASS=${{ secrets.DB_PASS }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_CONNECTION_NAME=${{ secrets.DB_CONNECTION_NAME }}
            DB_POOL_SIZE=5
            
            # Firestore (V2 Collection)
            FIRESTORE_DATABASE_ID=agentkai-v2-dev
            FIRESTORE_SESSION_COLLECTION=kai_v2_graph_state_dev
            
            # Integraciones & Webhooks
            GOOGLE_CHAT_WEBHOOK_URL=${{ secrets.GOOGLE_CHAT_WEBHOOK_URL_DEV }}
            TI_GOOGLE_CHAT_WEBHOOK_URL=${{ secrets.TI_GOOGLE_CHAT_WEBHOOK_URL }}
            APP_EMAIL_SENDER_IDENTITY=${{ secrets.APP_EMAIL_SENDER_IDENTITY }}
            
            # Storage
            GCS_ATTACHMENT_BUCKET=${{ secrets.GCS_BUCKET_NAME }}
            
            # Configuración General
            APP_BASE_URL=${{ secrets.APP_BASE_URL_DEV }}
            
            # Secretos de Integraciones (Asana, Github, Looker - Requeridos por config.py)
            # Aunque solo uses Helpdesk, config.py valida que existan.
            ASANA_PERSONAL_ACCESS_TOKEN=${{ secrets.ASANA_PERSONAL_ACCESS_TOKEN }}
            ASANA_PROJECT_GID=${{ secrets.ASANA_PROJECT_GID }}
            LOOKERSDK_CLIENT_ID=${{ secrets.LOOKER_CLIENT_ID }}
            LOOKERSDK_CLIENT_SECRET=${{ secrets.LOOKER_CLIENT_SECRET }}
            GITHUB_PAT=${{ secrets.GITHUB_PAT }}
            GITHUB_WEBHOOK_SECRET=${{ secrets.GITHUB_WEBHOOK_SECRET }}

      # ==================================================================
      # DESPLIEGUE A PRODUCCIÓN (Rama: main)
      # ==================================================================
      - name: 'Deploy to Cloud Run (PROD)'
        if: github.ref == 'refs/heads/main'
        uses: 'google-github-actions/deploy-cloudrun@v1'
        with:
          service: 'kai-api-corev2-prod'
          image: 'gcr.io/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}:${{ github.sha }}'
          region: '${{ env.REGION }}'
          flags: '--allow-unauthenticated --memory=4Gi --cpu=4 --min-instances=1'
          env_vars: |
            GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
            LOCATION=${{ env.REGION }}
            GEMINI_MODEL_ID=gemini-2.5-flash
            
            # Base de Datos (Cloud SQL)
            DB_USER=${{ secrets.DB_USER }}
            DB_PASS=${{ secrets.DB_PASS }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_CONNECTION_NAME=${{ secrets.DB_CONNECTION_NAME }}
            DB_POOL_SIZE=10
            
            # Firestore (V2 Collection)
            FIRESTORE_DATABASE_ID=agentkai-v2
            FIRESTORE_SESSION_COLLECTION=kai_v2_graph_state_prod
            
            # Integraciones & Webhooks
            GOOGLE_CHAT_WEBHOOK_URL=${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}
            TI_GOOGLE_CHAT_WEBHOOK_URL=${{ secrets.TI_GOOGLE_CHAT_WEBHOOK_URL }}
            APP_EMAIL_SENDER_IDENTITY=${{ secrets.APP_EMAIL_SENDER_IDENTITY }}
            
            # Storage
            GCS_ATTACHMENT_BUCKET=${{ secrets.GCS_BUCKET_NAME }}
            
            # Configuración General
            APP_BASE_URL=${{ secrets.APP_BASE_URL_PROD }}
            
            # Secretos de Integraciones
            ASANA_PERSONAL_ACCESS_TOKEN=${{ secrets.ASANA_PERSONAL_ACCESS_TOKEN }}
            ASANA_PROJECT_GID=${{ secrets.ASANA_PROJECT_GID }}
            LOOKERSDK_CLIENT_ID=${{ secrets.LOOKER_CLIENT_ID }}
            LOOKERSDK_CLIENT_SECRET=${{ secrets.LOOKER_CLIENT_SECRET }}
            GITHUB_PAT=${{ secrets.GITHUB_PAT }}
            GITHUB_WEBHOOK_SECRET=${{ secrets.GITHUB_WEBHOOK_SECRET }}