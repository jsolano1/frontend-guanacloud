name: Deploy DirIA Frontend Web

on:
  workflow_dispatch:
  
  push:
    branches:
      - develop
      - main
    paths:
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'Dockerfile'
      - 'nginx.conf'
      - 'package.json'
      - 'vite.config.ts'
      - '.github/workflows/deploy_v2.yml'

env:
  PROJECT_ID: diria-core-app
  REGION: us-central1
  REPO_NAME: diria-core-app

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v1'

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Set Environment Variables
        run: |
          if [[ $GITHUB_REF_NAME == 'main' ]]; then
            echo "Ambiente: PRODUCCION ðŸš€"
            echo "SERVICE_NAME=diria-frontend-web-prod" >> $GITHUB_ENV
            echo "CLOUD_RUN_FLAGS=--allow-unauthenticated --memory=512Mi --cpu=1 --min-instances=1" >> $GITHUB_ENV
            
          else
            echo "Ambiente: DESARROLLO ðŸ› ï¸"
            echo "SERVICE_NAME=diria-frontend-web-dev" >> $GITHUB_ENV
            echo "CLOUD_RUN_FLAGS=--allow-unauthenticated --memory=512Mi --cpu=1" >> $GITHUB_ENV
          fi

      - name: Build Docker Image
        run: |
          IMAGE_TAG=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
          docker build -f Dockerfile -t $IMAGE_TAG .

      - name: Push Docker Image
        run: |
          IMAGE_TAG=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
          docker push $IMAGE_TAG

      - name: Deploy to Cloud Run
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
          flags: ${{ env.CLOUD_RUN_FLAGS }}